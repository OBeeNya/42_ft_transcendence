{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.CacheInterceptor = void 0;\nconst tslib_1 = require(\"tslib\");\nconst rxjs_1 = require(\"rxjs\");\nconst operators_1 = require(\"rxjs/operators\");\nconst decorators_1 = require(\"../../decorators\");\nconst file_stream_1 = require(\"../../file-stream\");\nconst logger_service_1 = require(\"../../services/logger.service\");\nconst load_package_util_1 = require(\"../../utils/load-package.util\");\nconst shared_utils_1 = require(\"../../utils/shared.utils\");\nconst cache_constants_1 = require(\"../cache.constants\");\n/** @deprecated */\nconst HTTP_ADAPTER_HOST = 'HttpAdapterHost';\n/** @deprecated */\nconst REFLECTOR = 'Reflector';\n/**\n * @see [Caching](https://docs.nestjs.com/techniques/caching)\n *\n * @deprecated `CacheModule` (from the `@nestjs/common` package) is deprecated and will be removed in the next major release. Please, use the `@nestjs/cache-manager` package instead\n * @publicApi\n */\nlet CacheInterceptor = class CacheInterceptor {\n  constructor(cacheManager, reflector) {\n    this.cacheManager = cacheManager;\n    this.reflector = reflector;\n    this.allowedMethods = ['GET'];\n    // We need to check if the cache-manager package is v5 or greater\n    // because the set method signature changed in v5\n    const cacheManagerPackage = (0, load_package_util_1.loadPackage)('cache-manager', 'CacheModule', () => require('cache-manager'));\n    this.cacheManagerIsv5OrGreater = 'memoryStore' in cacheManagerPackage;\n    logger_service_1.Logger.warn('DEPRECATED! \"CacheModule\" (from the \"@nestjs/common\" package) is deprecated and will be removed in the next major release. Please, use the \"@nestjs/cache-manager\" package instead.');\n  }\n  async intercept(context, next) {\n    var _a;\n    const key = this.trackBy(context);\n    const ttlValueOrFactory = (_a = this.reflector.get(cache_constants_1.CACHE_TTL_METADATA, context.getHandler())) !== null && _a !== void 0 ? _a : null;\n    if (!key) {\n      return next.handle();\n    }\n    try {\n      const value = await this.cacheManager.get(key);\n      if (!(0, shared_utils_1.isNil)(value)) {\n        return (0, rxjs_1.of)(value);\n      }\n      const ttl = (0, shared_utils_1.isFunction)(ttlValueOrFactory) ? await ttlValueOrFactory(context) : ttlValueOrFactory;\n      return next.handle().pipe((0, operators_1.tap)(async response => {\n        if (response instanceof file_stream_1.StreamableFile) {\n          return;\n        }\n        const args = [key, response];\n        if (!(0, shared_utils_1.isNil)(ttl)) {\n          args.push(this.cacheManagerIsv5OrGreater ? ttl : {\n            ttl\n          });\n        }\n        try {\n          await this.cacheManager.set(...args);\n        } catch (err) {\n          logger_service_1.Logger.error(`An error has occurred when inserting \"key: ${key}\", \"value: ${response}\"`, 'CacheInterceptor');\n        }\n      }));\n    } catch (_b) {\n      return next.handle();\n    }\n  }\n  trackBy(context) {\n    const httpAdapter = this.httpAdapterHost.httpAdapter;\n    const isHttpApp = httpAdapter && !!httpAdapter.getRequestMethod;\n    const cacheMetadata = this.reflector.get(cache_constants_1.CACHE_KEY_METADATA, context.getHandler());\n    if (!isHttpApp || cacheMetadata) {\n      return cacheMetadata;\n    }\n    const request = context.getArgByIndex(0);\n    if (!this.isRequestCacheable(context)) {\n      return undefined;\n    }\n    return httpAdapter.getRequestUrl(request);\n  }\n  isRequestCacheable(context) {\n    const req = context.switchToHttp().getRequest();\n    return this.allowedMethods.includes(req.method);\n  }\n};\ntslib_1.__decorate([(0, decorators_1.Optional)(), (0, decorators_1.Inject)(HTTP_ADAPTER_HOST), tslib_1.__metadata(\"design:type\", Object)], CacheInterceptor.prototype, \"httpAdapterHost\", void 0);\nCacheInterceptor = tslib_1.__decorate([(0, decorators_1.Injectable)(), tslib_1.__param(0, (0, decorators_1.Inject)(cache_constants_1.CACHE_MANAGER)), tslib_1.__param(1, (0, decorators_1.Inject)(REFLECTOR)), tslib_1.__metadata(\"design:paramtypes\", [Object, Object])], CacheInterceptor);\nexports.CacheInterceptor = CacheInterceptor;","map":{"version":3,"names":["Object","defineProperty","exports","value","CacheInterceptor","tslib_1","require","rxjs_1","operators_1","decorators_1","file_stream_1","logger_service_1","load_package_util_1","shared_utils_1","cache_constants_1","HTTP_ADAPTER_HOST","REFLECTOR","constructor","cacheManager","reflector","allowedMethods","cacheManagerPackage","loadPackage","cacheManagerIsv5OrGreater","Logger","warn","intercept","context","next","_a","key","trackBy","ttlValueOrFactory","get","CACHE_TTL_METADATA","getHandler","handle","isNil","of","ttl","isFunction","pipe","tap","response","StreamableFile","args","push","set","err","error","_b","httpAdapter","httpAdapterHost","isHttpApp","getRequestMethod","cacheMetadata","CACHE_KEY_METADATA","request","getArgByIndex","isRequestCacheable","undefined","getRequestUrl","req","switchToHttp","getRequest","includes","method","__decorate","Optional","Inject","__metadata","prototype","Injectable","__param","CACHE_MANAGER"],"sources":["/home/benjamin/Documents/42/42_ft_transcendence/front/node_modules/@nestjs/common/cache/interceptors/cache.interceptor.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.CacheInterceptor = void 0;\nconst tslib_1 = require(\"tslib\");\nconst rxjs_1 = require(\"rxjs\");\nconst operators_1 = require(\"rxjs/operators\");\nconst decorators_1 = require(\"../../decorators\");\nconst file_stream_1 = require(\"../../file-stream\");\nconst logger_service_1 = require(\"../../services/logger.service\");\nconst load_package_util_1 = require(\"../../utils/load-package.util\");\nconst shared_utils_1 = require(\"../../utils/shared.utils\");\nconst cache_constants_1 = require(\"../cache.constants\");\n/** @deprecated */\nconst HTTP_ADAPTER_HOST = 'HttpAdapterHost';\n/** @deprecated */\nconst REFLECTOR = 'Reflector';\n/**\n * @see [Caching](https://docs.nestjs.com/techniques/caching)\n *\n * @deprecated `CacheModule` (from the `@nestjs/common` package) is deprecated and will be removed in the next major release. Please, use the `@nestjs/cache-manager` package instead\n * @publicApi\n */\nlet CacheInterceptor = class CacheInterceptor {\n    constructor(cacheManager, reflector) {\n        this.cacheManager = cacheManager;\n        this.reflector = reflector;\n        this.allowedMethods = ['GET'];\n        // We need to check if the cache-manager package is v5 or greater\n        // because the set method signature changed in v5\n        const cacheManagerPackage = (0, load_package_util_1.loadPackage)('cache-manager', 'CacheModule', () => require('cache-manager'));\n        this.cacheManagerIsv5OrGreater = 'memoryStore' in cacheManagerPackage;\n        logger_service_1.Logger.warn('DEPRECATED! \"CacheModule\" (from the \"@nestjs/common\" package) is deprecated and will be removed in the next major release. Please, use the \"@nestjs/cache-manager\" package instead.');\n    }\n    async intercept(context, next) {\n        var _a;\n        const key = this.trackBy(context);\n        const ttlValueOrFactory = (_a = this.reflector.get(cache_constants_1.CACHE_TTL_METADATA, context.getHandler())) !== null && _a !== void 0 ? _a : null;\n        if (!key) {\n            return next.handle();\n        }\n        try {\n            const value = await this.cacheManager.get(key);\n            if (!(0, shared_utils_1.isNil)(value)) {\n                return (0, rxjs_1.of)(value);\n            }\n            const ttl = (0, shared_utils_1.isFunction)(ttlValueOrFactory)\n                ? await ttlValueOrFactory(context)\n                : ttlValueOrFactory;\n            return next.handle().pipe((0, operators_1.tap)(async (response) => {\n                if (response instanceof file_stream_1.StreamableFile) {\n                    return;\n                }\n                const args = [key, response];\n                if (!(0, shared_utils_1.isNil)(ttl)) {\n                    args.push(this.cacheManagerIsv5OrGreater ? ttl : { ttl });\n                }\n                try {\n                    await this.cacheManager.set(...args);\n                }\n                catch (err) {\n                    logger_service_1.Logger.error(`An error has occurred when inserting \"key: ${key}\", \"value: ${response}\"`, 'CacheInterceptor');\n                }\n            }));\n        }\n        catch (_b) {\n            return next.handle();\n        }\n    }\n    trackBy(context) {\n        const httpAdapter = this.httpAdapterHost.httpAdapter;\n        const isHttpApp = httpAdapter && !!httpAdapter.getRequestMethod;\n        const cacheMetadata = this.reflector.get(cache_constants_1.CACHE_KEY_METADATA, context.getHandler());\n        if (!isHttpApp || cacheMetadata) {\n            return cacheMetadata;\n        }\n        const request = context.getArgByIndex(0);\n        if (!this.isRequestCacheable(context)) {\n            return undefined;\n        }\n        return httpAdapter.getRequestUrl(request);\n    }\n    isRequestCacheable(context) {\n        const req = context.switchToHttp().getRequest();\n        return this.allowedMethods.includes(req.method);\n    }\n};\ntslib_1.__decorate([\n    (0, decorators_1.Optional)(),\n    (0, decorators_1.Inject)(HTTP_ADAPTER_HOST),\n    tslib_1.__metadata(\"design:type\", Object)\n], CacheInterceptor.prototype, \"httpAdapterHost\", void 0);\nCacheInterceptor = tslib_1.__decorate([\n    (0, decorators_1.Injectable)(),\n    tslib_1.__param(0, (0, decorators_1.Inject)(cache_constants_1.CACHE_MANAGER)),\n    tslib_1.__param(1, (0, decorators_1.Inject)(REFLECTOR)),\n    tslib_1.__metadata(\"design:paramtypes\", [Object, Object])\n], CacheInterceptor);\nexports.CacheInterceptor = CacheInterceptor;\n"],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}